trigger:
- main
pool:
  vmImage: 'windows-latest'
variables:
- group: aws-windows-vars
steps:
# =========================
# BUILD FRONTEND
# =========================
- task: NodeTool@0
  inputs:
    versionSpec: '18.x'
  displayName: 'Install Node.js'
- script: |
    cd frontend
    npm install
    npm run build
  displayName: 'Build Vue frontend'
# =========================
# BUILD BACKEND
# =========================
- script: |
    cd backend
    npm install
  displayName: 'Install backend dependencies'
# =========================
# PUBLISH ARTIFACTS
# =========================
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: 'frontend/dist'
    ArtifactName: 'frontend'
  displayName: 'Publish frontend'
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: 'backend'
    ArtifactName: 'backend'
  displayName: 'Publish backend'
# =========================
# DEPLOY TO WINDOWS EC2
# =========================
- task: PowerShell@2
  displayName: 'Deploy to AWS Windows EC2'
  inputs:
    targetType: 'inline'
    script: |
      $secpasswd = ConvertTo-SecureString "$(EC2_PASS)" -AsPlainText -Force
      $cred = New-Object System.Management.Automation.PSCredential ("$(EC2_USER)", $secpasswd)
      $session = New-PSSession `
        -ComputerName $(EC2_HOST) `
        -Credential $cred `
        -Authentication Basic
      # FRONTEND DEPLOY
      Invoke-Command -Session $session -ScriptBlock {
          if (Test-Path "$(FRONTEND_PATH)") {
              Remove-Item "$(FRONTEND_PATH)\*" -Recurse -Force
          }
      }
      Copy-Item `
        -Path "$(Pipeline.Workspace)\frontend\*" `
        -Destination "$(FRONTEND_PATH)" `
        -ToSession $session `
        -Recurse -Force
      # BACKEND DEPLOY
      Invoke-Command -Session $session -ScriptBlock {
          if (Test-Path "$(BACKEND_PATH)") {
              Remove-Item "$(BACKEND_PATH)\*" -Recurse -Force
          }
      }
      Copy-Item `
        -Path "$(Pipeline.Workspace)\backend\*" `
        -Destination "$(BACKEND_PATH)" `
        -ToSession $session `
        -Recurse -Force
      # BACKEND START/RESTART
      Invoke-Command -Session $session -ScriptBlock {
          cd "$(BACKEND_PATH)"
          pm2 delete backend-api -ErrorAction SilentlyContinue
          pm2 start server.js --name backend-api
          pm2 save
      }
      Remove-PSSession $session